name: Security Scan (SCA Detallado)

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  schedule:
    - cron: '0 8 * * 1'  # Cada lunes a las 8 AM

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  security-audit:
    name: 🔒 Análisis de Seguridad
    runs-on: ubuntu-latest
    
    steps:
      - name: 📥 Checkout del código
        uses: actions/checkout@v4
      
      - name: 🟢 Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'
      
      - name: 📦 Instalar dependencias
        run: npm ci
      
      - name: 🔍 npm audit detallado
        id: audit
        run: |
          echo "## 🔒 Reporte de Seguridad" > security-report.md
          echo "" >> security-report.md
          echo "### 📊 Resumen de npm audit" >> security-report.md
          echo "\`\`\`" >> security-report.md
          npm audit >> security-report.md || true
          echo "\`\`\`" >> security-report.md
          
          # Guardar JSON para análisis
          npm audit --json > npm-audit-full.json || true
          
          # Verificar severidad
          if npm audit --audit-level=high; then
            echo "✅ No se encontraron vulnerabilidades críticas"
            echo "status=success" >> $GITHUB_OUTPUT
          else
            echo "⚠️ Se encontraron vulnerabilidades"
            echo "status=warning" >> $GITHUB_OUTPUT
          fi
        continue-on-error: true
      
      - name: 📋 Listar dependencias desactualizadas
        run: |
          echo "" >> security-report.md
          echo "### 📦 Paquetes desactualizados" >> security-report.md
          echo "\`\`\`" >> security-report.md
          npm outdated >> security-report.md || true
          echo "\`\`\`" >> security-report.md
        continue-on-error: true
      
      - name: 📤 Subir reportes
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-reports
          path: |
            security-report.md
            npm-audit-full.json
          retention-days: 90
      
      - name: 💬 Comentar en PR
        if: github.event_name == 'pull_request' && steps.audit.outputs.status == 'warning'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('security-report.md', 'utf8');
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '## ⚠️ Alerta de Seguridad\n\n' + 
                    'Se encontraron vulnerabilidades en las dependencias.\n\n' +
                    '<details>\n<summary>📋 Ver reporte completo</summary>\n\n' +
                    report + '\n</details>\n\n' +
                    '**Acción recomendada:** Ejecuta `npm audit fix` localmente.'
            });